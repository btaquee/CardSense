# Backend Integration Guide

This document explains the changes made to align the frontend with the backend API structure.

## Summary of Changes

The frontend has been updated to match the backend API endpoints and data models that your buddy has implemented.

---

## Updated Files

### 1. **Types** (`web/src/types/index.ts`)

#### Credit Card Types
- **`CreditCard`**: Now includes `ftf` (Foreign Transaction Fee) boolean field
- **`CardBenefit`**: New type for card benefits with array of benefit strings
- **`UserCard`**: Updated to match backend serializer:
  - Uses `card` (number) for card_id
  - Includes `card_name` (generated by backend)
  - Uses `notes` instead of `nickname`
  - Uses `is_active` instead of `is_primary`
- **`RewardRule`**: Updated to match backend:
  - Uses `multiplier` (number) instead of `reward_value`
  - Uses `category` (string or string[]) with specific category choices
  - Removed `reward_type`, `cap_period`, `start_date`, `end_date`

#### New Types
- **`RewardCategory`**: Enum type for all available spending categories
- **`UserCategorySelection`**: User's selected spending categories for optimizer
- **`OptimizerResult`**: Best card recommendation for a category

---

### 2. **Card Service** (`web/src/services/card.service.ts`)

Updated all endpoints to match backend URLs:

```typescript
// OLD: '/cards/'
// NEW: '/cards/cards/'

// Card Database (Read-Only)
getAllCards()                    → GET /api/cards/cards/
getCard(id)                      → GET /api/cards/cards/{id}/
getRewardRules()                 → GET /api/cards/reward-rules/
getCardBenefits()                → GET /api/cards/card-benefits/

// User Cards (Full CRUD)
getUserCards()                   → GET /api/cards/user-cards/
addUserCard(card_id, notes, is_active) → POST /api/cards/user-cards/
updateUserCard(id, data)         → PATCH /api/cards/user-cards/{id}/
removeUserCard(id)               → DELETE /api/cards/user-cards/{id}/
```

**Breaking Changes:**
- Removed: `getCardRewards()`, `setPrimaryCard()`, `getRecommendation()`, `compareCards()`
- Changed: `addUserCard()` now takes `notes` and `is_active` instead of `nickname`
- Added: `updateUserCard()` for PATCH requests

---

### 3. **API Service** (`web/src/services/api.ts`)

Added missing `patch()` method:

```typescript
async patch<T>(url: string, data?: any): Promise<ApiResponse<T>>
```

---

### 4. **Optimizer Service** (NEW: `web/src/services/optimizer.service.ts`)

New service for optimizer functionality:

```typescript
// User Category Selections
getUserCategorySelections()      → GET /api/optimizer/user-category-selections/
addCategorySelection(category)   → POST /api/optimizer/user-category-selections/
removeCategorySelection(id)      → DELETE /api/optimizer/user-category-selections/{id}/

// Get Best Cards for User's Categories
getOptimizerDashboard()          → GET /api/optimizer/my-optimizer-dashboard/
```

---

## Backend API Structure

### Cards API (`/api/cards/`)

#### Read-Only Endpoints (Card Database)
- `GET /api/cards/cards/` - List all cards with nested reward_rules and benefits
- `GET /api/cards/cards/{id}/` - Get single card details
- `GET /api/cards/reward-rules/` - List all reward rules
- `GET /api/cards/card-benefits/` - List all benefits

#### User Personalization Endpoints
- `GET /api/cards/user-cards/` - List current user's cards
- `POST /api/cards/user-cards/` - Add card to user's wallet
  ```json
  {
    "card": 1,
    "notes": "My travel card",
    "is_active": true
  }
  ```
- `PATCH /api/cards/user-cards/{id}/` - Update user card
  ```json
  {
    "notes": "Updated note",
    "is_active": false
  }
  ```
- `DELETE /api/cards/user-cards/{id}/` - Remove card from wallet

---

### Optimizer API (`/api/optimizer/`)

#### User Category Selections
- `GET /api/optimizer/user-category-selections/` - List user's selected categories
- `POST /api/optimizer/user-category-selections/` - Add category to dashboard
  ```json
  {
    "category_tag": "DINING"
  }
  ```
- `DELETE /api/optimizer/user-category-selections/{id}/` - Remove category

#### Optimizer Dashboard
- `GET /api/optimizer/my-optimizer-dashboard/` - Get best cards for all selected categories
  
  **Returns:**
  ```json
  [
    {
      "category_tag": "DINING",
      "best_card": {
        "card_id": 3,
        "card_name": "CHASE Sapphire Preferred"
      },
      "multiplier": 3.0,
      "rationale": "3.0× on DINING (from your wallet).",
      "top3": [
        {
          "card_id": 5,
          "card_name": "AMEX Gold Card",
          "multiplier": 3.0
        }
      ]
    }
  ]
  ```

---

### Transactions API (`/api/transactions/`)

Currently only has health endpoint. The transaction service is already set up for future endpoints.

---

### Budgets API (`/api/budgets/`)

Currently only has health endpoint. The budget service is already set up for future endpoints.

---

## Available Spending Categories

The backend supports these category choices:

- `SELECTED_CATEGORIES` - Special category for rotating categories
- `RENT`
- `ONLINE_SHOPPING`
- `DINING`
- `GROCERIES`
- `PHARMACY`
- `GAS`
- `GENERAL_TRAVEL`
- `AIRLINE_TRAVEL`
- `HOTEL_TRAVEL`
- `TRANSIT`
- `ENTERTAINMENT`
- `OTHER` - Base/anywhere rate

---

## Usage Examples

### Example 1: Display All Cards

```typescript
import { cardService } from './services/card.service';

// Get all cards from database
const response = await cardService.getAllCards();
if (response.success && response.data) {
  const cards = response.data;
  // Each card includes:
  // - id, name, issuer, annual_fee, ftf
  // - reward_rules[] with multiplier and categories
  // - benefits[] with array of benefit strings
}
```

### Example 2: Add Card to User's Wallet

```typescript
import { cardService } from './services/card.service';

// Add card to user's wallet
const response = await cardService.addUserCard(
  3,  // card_id
  "My main dining card",  // notes
  true  // is_active
);

if (response.success) {
  console.log('Card added to wallet!');
}
```

### Example 3: Get Best Card Recommendations

```typescript
import { optimizerService } from './services/optimizer.service';

// First, user selects categories they care about
await optimizerService.addCategorySelection('DINING');
await optimizerService.addCategorySelection('GAS');
await optimizerService.addCategorySelection('GROCERIES');

// Get best cards for all selected categories
const response = await optimizerService.getOptimizerDashboard();
if (response.success && response.data) {
  response.data.forEach(result => {
    console.log(`Category: ${result.category_tag}`);
    console.log(`Best Card: ${result.best_card?.card_name}`);
    console.log(`Multiplier: ${result.multiplier}×`);
    console.log(`Reason: ${result.rationale}`);
  });
}
```

### Example 4: Update User Card

```typescript
import { cardService } from './services/card.service';

// Deactivate a card
await cardService.updateUserCard(userCardId, {
  is_active: false,
  notes: "No longer using this card"
});
```

---

## Testing with Backend

### 1. Start the Backend Server

```bash
cd CardSense
python manage.py runserver
```

Backend will be available at `http://127.0.0.1:8000/`

### 2. Start the Frontend

```bash
cd web
npm start
```

Frontend will be available at `http://localhost:3000/`

### 3. Test API Endpoints

You can test the backend APIs directly:

- Cards: http://127.0.0.1:8000/api/cards/cards/
- User Cards: http://127.0.0.1:8000/api/cards/user-cards/
- Reward Rules: http://127.0.0.1:8000/api/cards/reward-rules/
- Benefits: http://127.0.0.1:8000/api/cards/card-benefits/
- Optimizer Categories: http://127.0.0.1:8000/api/optimizer/user-category-selections/
- Optimizer Dashboard: http://127.0.0.1:8000/api/optimizer/my-optimizer-dashboard/

---

## Important Notes

1. **Authentication**: ⚠️ **NOT YET IMPLEMENTED IN BACKEND**
   - Auth endpoints (`/api/accounts/auth/login/`, etc.) need to be implemented by backend team
   - Frontend authentication is currently DISABLED for testing
   - See `AUTHENTICATION_SETUP.md` for details on what's needed
   - DO NOT re-enable authentication in frontend until backend implements auth endpoints

2. **CORS**: Already configured in backend settings to allow `http://localhost:3000`

3. **Data Structure**: 
   - Cards in the database are read-only (managed by admin)
   - Users can only add/remove cards from their personal wallet
   - Optimizer works only with cards in the user's wallet

4. **Reward Rules**: 
   - Each card can have multiple reward rules
   - Categories can be multi-select (e.g., a rule applies to both DINING and ENTERTAINMENT)
   - Multipliers are decimal values (3.0 means 3x points/cashback)

5. **Future Implementation**:
   - Transactions and Budgets APIs are not fully implemented yet
   - Services are ready but endpoints only return health checks

---

## Migration Checklist

- [x] Update TypeScript types to match backend models
- [x] Update card service endpoints
- [x] Add optimizer service
- [x] Add PATCH method to API service
- [ ] Update UI components to use new data structure
- [ ] Implement authentication flow
- [ ] Test all endpoints with real backend
- [ ] Update any hardcoded mock data

---

## Getting Help

If you encounter issues:

1. Check the backend documentation in `PROJECT_SUMMARY.md`
2. Use Django REST Framework's browsable API at `http://127.0.0.1:8000/api/`
3. Check browser console for API errors
4. Verify authentication token is being sent correctly

---

**Last Updated**: October 29, 2025

